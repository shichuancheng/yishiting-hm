// èŠå¤©é¡µé¢
import { router } from '@kit.ArkUI';
import { Message, StreamChunk, ExampleQuestion } from '../models/ChatModels';
import ChatService from '../services/ChatService';
import { DateUtils } from '../utils/DateUtils';
import { CHAT_MODES } from '../constants/Modes';

@Entry
@Component
struct ChatPage {
  @State messages: Message[] = [];
  @State inputText: string = '';
  @State isLoading: boolean = false;
  @State currentRole: string = '';
  @State currentAvatar: string = '';
  @State currentContent: string = '';

  private modeId: string = '';
  private modeName: string = '';
  private welcomeTitle: string = '';
  private welcomeDesc: string = '';
  private inputPlaceholder: string = '';
  private modeIcon: string = '';
  private examples: ExampleQuestion[] = [];
  private advisorNames: string[] = [];
  private scroller: Scroller = new Scroller();
  private inputController: TextInputController = new TextInputController();

  aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, string>;
    this.modeId = params['modeId'] || 'emperor';
    this.modeName = params['modeName'] || 'ä¸‰å›½è°‹å£«å›¢';

    // è·å–æ¨¡å¼é…ç½®
    const mode = CHAT_MODES.find(m => m.id === this.modeId);
    if (mode) {
      this.welcomeTitle = mode.welcomeTitle;
      this.welcomeDesc = mode.welcomeDesc;
      this.inputPlaceholder = mode.inputPlaceholder;
      this.modeIcon = mode.icon;
      this.examples = mode.examples;
      this.advisorNames = mode.advisors.map(a => `${a.avatar} ${a.name}`);
    }

    // ç¡®ä¿åˆå§‹çŠ¶æ€æ­£ç¡®
    this.isLoading = false;
    this.inputText = '';
    this.currentRole = '';
    this.currentAvatar = '';
    this.currentContent = '';
    
    console.info('[ChatPage] Page initialized, isLoading:', this.isLoading);
  }

  onPageShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶ï¼Œç¡®ä¿è¾“å…¥æ¡†å¯ç”¨
    console.info('[ChatPage] Page shown, current isLoading:', this.isLoading);
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.TopBar()

      // æ¶ˆæ¯åˆ—è¡¨æˆ–æ¬¢è¿é¡µ
      if (this.messages.length === 0) {
        this.WelcomePanel()
      } else {
        List({ scroller: this.scroller }) {
          ForEach(this.messages, (msg: Message) => {
            ListItem() {
              this.MessageItem(msg)
            }
          })

          // æ­£åœ¨è¾“å…¥çš„æ¶ˆæ¯
          if (this.isLoading && this.currentRole) {
            ListItem() {
              this.StreamingMessage()
            }
          }
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .backgroundColor('#1a1a2e')
      }

      // è¾“å…¥æ¡†
      this.InputBar()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1a1a2e')
  }

  @Builder
  TopBar() {
    Row() {
      Image($r('sys.symbol.chevron_left'))
        .width(24)
        .height(24)
        .fillColor('#FFFFFF')
        .onClick(() => {
          router.back();
        })

      Text(this.modeName)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FFFFFF')
        .margin({ left: 12 })

      Blank()
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#16213e')
  }

  @Builder
  WelcomePanel() {
    Scroll() {
      Column({ space: 16 }) {
        Text(this.modeIcon)
          .fontSize(64)
          .margin({ top: 40 })

        Text(this.welcomeTitle)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')

        Text(this.welcomeDesc)
          .fontSize(14)
          .fontColor('#B0B0B0')
          .textAlign(TextAlign.Center)
          .padding({ left: 20, right: 20 })

        // è§’è‰²åˆ—è¡¨
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Center }) {
          ForEach(this.advisorNames, (name: string) => {
            Text(name)
              .fontSize(13)
              .fontColor('rgba(255,255,255,0.8)')
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor('rgba(255,255,255,0.08)')
              .borderRadius(16)
              .margin(4)
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20 })

        // ç¤ºä¾‹é—®é¢˜
        Column({ space: 12 }) {
          Text('è¯•è¯•é—®ï¼š')
            .fontSize(13)
            .fontColor('rgba(255,255,255,0.5)')

          ForEach(this.examples, (example: ExampleQuestion) => {
            Button(example.text)
              .fontSize(13)
              .fontColor('#FFFFFF')
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(20)
              .border({ width: 1, color: 'rgba(255,255,255,0.2)' })
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .onClick(() => {
                this.sendMessageWithText(example.question);
              })
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20 })
        .margin({ top: 24 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder
  MessageItem(msg: Message) {
    Column() {
      if (msg.role === 'user') {
        // ç”¨æˆ·æ¶ˆæ¯
        Row() {
          Blank()
          Column() {
            Text(msg.content)
              .fontSize(15)
              .fontColor('#FFFFFF')
              .padding(12)
              .backgroundColor('#667eea')
              .borderRadius(18)
          }
          .width('75%')
        }
        .width('100%')
        .margin({ top: 8, bottom: 8 })
      } else {
        // AI æ¶ˆæ¯
        Row() {
          Text(msg.avatar || 'ğŸ¤–')
            .fontSize(32)
            .margin({ right: 8 })

          Column({ space: 4 }) {
            Text(msg.name || 'AI')
              .fontSize(13)
              .fontColor('#ffd700')
              .fontWeight(FontWeight.Medium)

            Text(msg.content)
              .fontSize(15)
              .fontColor('#FFFFFF')
              .padding(12)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(12)
          }
          .alignItems(HorizontalAlign.Start)
          .width('75%')

          Blank()
        }
        .width('100%')
        .alignItems(VerticalAlign.Top)
        .margin({ top: 8, bottom: 8 })
      }
    }
    .width('100%')
  }

  @Builder
  StreamingMessage() {
    Row() {
      Text(this.currentAvatar)
        .fontSize(32)
        .margin({ right: 8 })

      Column({ space: 4 }) {
        Text(this.currentRole)
          .fontSize(13)
          .fontColor('#ffd700')
          .fontWeight(FontWeight.Medium)

        Text(this.currentContent || 'æ­£åœ¨æ€è€ƒ...')
          .fontSize(15)
          .fontColor('#FFFFFF')
          .padding(12)
          .backgroundColor('rgba(255,255,255,0.1)')
          .borderRadius(12)
      }
      .alignItems(HorizontalAlign.Start)
      .width('75%')

      Blank()
    }
    .width('100%')
    .alignItems(VerticalAlign.Top)
    .margin({ top: 8, bottom: 8 })
  }

  @Builder
  InputBar() {
    Row() {
      TextInput({ 
        placeholder: this.inputPlaceholder, 
        text: this.inputText,
        controller: this.inputController 
      })
        .layoutWeight(1)
        .height(44)
        .backgroundColor('rgba(255,255,255,0.05)')
        .placeholderColor('#666666')
        .fontColor('#FFFFFF')
        .borderRadius(22)
        .padding({ left: 16, right: 16 })
        .border({ width: 1, color: 'rgba(255,255,255,0.2)' })
        .onChange((value: string) => {
          this.inputText = value;
        })
        .enabled(!this.isLoading)

      Button(this.isLoading ? 'åœæ­¢' : 'å‘é€')
        .width(70)
        .height(44)
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .backgroundColor(this.isLoading ? '#ff6b6b' : (this.modeId === 'emperor' ? '#667eea' : '#f5576c'))
        .borderRadius(22)
        .margin({ left: 12 })
        .enabled(this.isLoading || this.inputText.trim().length > 0)
        .onClick(() => {
          if (this.isLoading) {
            // åœæ­¢åŠ è½½ï¼Œé‡ç½®çŠ¶æ€
            this.isLoading = false;
            this.currentRole = '';
            this.currentAvatar = '';
            this.currentContent = '';
          } else {
            this.sendMessage();
          }
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('rgba(255,255,255,0.05)')
    .border({ width: { top: 1 }, color: 'rgba(255,255,255,0.1)' })
  }

  private sendMessageWithText(text: string) {
    if (this.isLoading) {
      console.info('[ChatPage] Cannot send example: already loading');
      return;
    }
    this.inputText = text;
    this.sendMessage();
  }

  private sendMessage() {
    if (this.inputText.trim().length === 0 || this.isLoading) {
      console.info('[ChatPage] Cannot send: inputText empty or already loading');
      return;
    }

    const userMessage: Message = {
      id: DateUtils.generateId(),
      role: 'user',
      content: this.inputText.trim(),
      timestamp: Date.now()
    };

    const messageToSend = this.inputText.trim();
    
    // å…ˆè®¾ç½® loading çŠ¶æ€ï¼Œå†æ¸…ç©ºè¾“å…¥
    this.isLoading = true;
    this.inputText = '';
    this.currentRole = '';
    this.currentAvatar = '';
    this.currentContent = '';
    
    console.info('[ChatPage] Sending message, isLoading set to:', this.isLoading);
    
    // ä¿å­˜å†å²è®°å½•ï¼ˆä¸åŒ…å«å½“å‰æ¶ˆæ¯ï¼‰
    const historyToSend = [...this.messages];
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°æ˜¾ç¤ºåˆ—è¡¨
    this.messages.push(userMessage);

    // æ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => {
      this.scroller.scrollEdge(Edge.Bottom);
    }, 100);

    // è®¾ç½®è¶…æ—¶ä¿æŠ¤ï¼Œé˜²æ­¢ isLoading ä¸€ç›´ä¸º true
    const timeoutId = setTimeout(() => {
      if (this.isLoading) {
        console.warn('Request timeout, resetting loading state');
        this.handleStreamError('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•');
      }
    }, 60000); // 60ç§’è¶…æ—¶

    // è°ƒç”¨ APIï¼ˆå‘é€å†å²è®°å½•ï¼Œä¸åŒ…å«å½“å‰æ¶ˆæ¯ï¼‰
    ChatService.sendMessage(
      messageToSend,
      historyToSend,
      this.modeId,
      (chunk: StreamChunk) => {
        this.handleStreamChunk(chunk);
      },
      () => {
        clearTimeout(timeoutId);
        this.handleStreamComplete();
      },
      (error: string) => {
        clearTimeout(timeoutId);
        this.handleStreamError(error);
      }
    );
  }

  private handleStreamChunk(chunk: StreamChunk) {
    if (chunk.type === 'role_start') {
      // æ–°è§’è‰²å¼€å§‹å‘è¨€
      if (this.currentRole && this.currentContent) {
        // ä¿å­˜ä¸Šä¸€ä¸ªè§’è‰²çš„æ¶ˆæ¯
        this.saveCurrentMessage();
      }
      this.currentRole = chunk.role || '';
      this.currentAvatar = chunk.avatar || 'ğŸ¤–';
      this.currentContent = '';
    } else if (chunk.type === 'content') {
      // è¿½åŠ å†…å®¹
      this.currentContent += chunk.content || '';
      // æ»šåŠ¨åˆ°åº•éƒ¨
      setTimeout(() => {
        this.scroller.scrollEdge(Edge.Bottom);
      }, 50);
    } else if (chunk.type === 'role_end') {
      // è§’è‰²å‘è¨€ç»“æŸ
      this.saveCurrentMessage();
      this.currentRole = '';
      this.currentAvatar = '';
      this.currentContent = '';
    } else if (chunk.type === 'error') {
      console.error('Stream error:', chunk.error);
    }
  }

  private handleStreamComplete() {
    this.isLoading = false;
    if (this.currentRole && this.currentContent) {
      this.saveCurrentMessage();
    }
    this.currentRole = '';
    this.currentAvatar = '';
    this.currentContent = '';
  }

  private handleStreamError(error: string) {
    console.error('[ChatPage] Stream error:', error);
    this.isLoading = false;
    this.currentRole = '';
    this.currentAvatar = '';
    this.currentContent = '';

    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    const errorMessage: Message = {
      id: DateUtils.generateId(),
      role: 'assistant',
      content: `æŠ±æ­‰ï¼Œå‡ºç°äº†é”™è¯¯ï¼š${error}`,
      name: 'ç³»ç»Ÿ',
      avatar: 'âš ï¸',
      timestamp: Date.now()
    };
    this.messages.push(errorMessage);
    
    // å¼ºåˆ¶åˆ·æ–°UI
    console.info('[ChatPage] Error handled, isLoading reset to:', this.isLoading);
  }

  private saveCurrentMessage() {
    if (this.currentContent.trim().length > 0) {
      const message: Message = {
        id: DateUtils.generateId(),
        role: 'assistant',
        content: this.currentContent.trim(),
        name: this.currentRole,
        avatar: this.currentAvatar,
        timestamp: Date.now()
      };
      this.messages.push(message);
    }
  }
}
