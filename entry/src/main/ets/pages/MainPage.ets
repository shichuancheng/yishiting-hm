// ä¸»é¡µé¢ - å¸¦åº•éƒ¨ Tab å¯¼èˆª
import { router } from '@kit.ArkUI';
import { CHAT_MODES } from '../constants/Modes';
import { ChatMode, Advisor } from '../models/ChatModels';

@Entry
@Component
struct MainPage {
  @State currentTab: number = 0;
  @State modes: ChatMode[] = CHAT_MODES;
  @State chatHistory: ChatHistoryItem[] = []; // èŠå¤©å†å²

  aboutToAppear() {
    // åŠ è½½èŠå¤©å†å²ï¼ˆåç»­å¯ä»¥ä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼‰
    this.loadChatHistory();
  }

  loadChatHistory() {
    // TODO: ä»æœ¬åœ°å­˜å‚¨åŠ è½½èŠå¤©å†å²
    // æš‚æ—¶ä½¿ç”¨ç¤ºä¾‹æ•°æ®
    this.chatHistory = [];
  }

  build() {
    Column() {
      // å†…å®¹åŒºåŸŸ
      if (this.currentTab === 0) {
        this.MessagesTab()
      } else {
        this.ContactsTab()
      }

      // åº•éƒ¨ Tab æ 
      this.BottomTabBar()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#EDEDED')
  }

  @Builder
  MessagesTab() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('æ¶ˆæ¯')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor('#000000')
      }
      .width('100%')
      .height(48)
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#EDEDED')
      .border({ width: { bottom: 0.5 }, color: '#D9D9D9' })

      // èŠå¤©å†å²åˆ—è¡¨
      if (this.chatHistory.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ’¬')
            .fontSize(64)
            .margin({ bottom: 16 })

          Text('æš‚æ— èŠå¤©è®°å½•')
            .fontSize(16)
            .fontColor('#888888')
            .margin({ bottom: 8 })

          Text('ç‚¹å‡»ä¸‹æ–¹"é€šè®¯å½•"é€‰æ‹©é¡¾é—®å¼€å§‹èŠå¤©')
            .fontSize(14)
            .fontColor('#B2B2B2')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column() {
            ForEach(this.chatHistory, (item: ChatHistoryItem, index: number) => {
              this.ChatHistoryItem(item, index === this.chatHistory.length - 1)
            })
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  ChatHistoryItem(item: ChatHistoryItem, isLast: boolean) {
    Column() {
      Row() {
        // å¤´åƒ
        Column() {
          Text(item.icon)
            .fontSize(24)
        }
        .width(48)
        .height(48)
        .backgroundColor('#F7F7F7')
        .borderRadius(4)
        .justifyContent(FlexAlign.Center)

        // ä¿¡æ¯
        Column({ space: 4 }) {
          Row() {
            Text(item.name)
              .fontSize(16)
              .fontColor('#000000')
              .layoutWeight(1)

            Text(item.timeText)
              .fontSize(12)
              .fontColor('#B2B2B2')
          }
          .width('100%')

          Text(item.lastMessage)
            .fontSize(14)
            .fontColor('#888888')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 12 })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })

      if (!isLast) {
        Divider()
          .color('#EBEBEB')
          .margin({ left: 76 })
      }
    }
    .width('100%')
    .onClick(() => {
      interface RouterParams {
        modeId: string;
        modeName: string;
      }

      const params: RouterParams = {
        modeId: item.modeId,
        modeName: item.name
      };

      router.pushUrl({
        url: 'pages/ChatPage',
        params: params
      });
    })
  }

  @Builder
  ContactsTab() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('é€šè®¯å½•')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor('#000000')
      }
      .width('100%')
      .height(48)
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#EDEDED')
      .border({ width: { bottom: 0.5 }, color: '#D9D9D9' })

      // æ¨¡å¼åˆ—è¡¨
      Scroll() {
        Column({ space: 0 }) {
          // é¡¶éƒ¨è¯´æ˜
          Column() {
            Text('é€‰æ‹©é€‚åˆä½ çš„é¡¾é—®å›¢')
              .fontSize(13)
              .fontColor('#888888')
          }
          .width('100%')
          .padding({ left: 16, top: 16, bottom: 8 })

          // æ¨¡å¼å¡ç‰‡åˆ—è¡¨
          Column() {
            ForEach(this.modes, (mode: ChatMode, index: number) => {
              this.ModeItem(mode, index === this.modes.length - 1)
            })
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
          .borderRadius(8)
          .margin({ left: 12, right: 12 })

          // åŠŸèƒ½ç‰¹æ€§
          this.FeaturesSection()
        }
        .width('100%')
        .padding({ bottom: 40 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor('#EDEDED')
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  ModeItem(mode: ChatMode, isLast: boolean) {
    Column() {
      Row() {
        // å›¾æ ‡
        Column() {
          Text(mode.icon)
            .fontSize(36)
        }
        .width(56)
        .height(56)
        .backgroundColor('#F7F7F7')
        .borderRadius(8)
        .justifyContent(FlexAlign.Center)

        // ä¿¡æ¯
        Column({ space: 4 }) {
          Text(mode.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#000000')

          Text(mode.description)
            .fontSize(13)
            .fontColor('#888888')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // é¡¾é—®å¤´åƒè¡Œ
          Row({ space: 4 }) {
            ForEach(mode.advisors.slice(0, 4), (advisor: Advisor) => {
              Text(advisor.avatar)
                .fontSize(14)
            })
            if (mode.advisors.length > 4) {
              Text(`+${mode.advisors.length - 4}`)
                .fontSize(11)
                .fontColor('#888888')
            }
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 12 })

        // ç®­å¤´
        Text('â€º')
          .fontSize(20)
          .fontColor('#C7C7CC')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })

      // åˆ†å‰²çº¿
      if (!isLast) {
        Divider()
          .color('#EBEBEB')
          .margin({ left: 84 })
      }
    }
    .width('100%')
    .onClick(() => {
      interface RouterParams {
        modeId: string;
        modeName: string;
      }

      const params: RouterParams = {
        modeId: mode.id,
        modeName: mode.name
      };

      router.pushUrl({
        url: 'pages/ChatPage',
        params: params
      });
    })
  }

  @Builder
  FeaturesSection() {
    Column({ space: 0 }) {
      // æ ‡é¢˜
      Column() {
        Text('åŠŸèƒ½ç‰¹ç‚¹')
          .fontSize(13)
          .fontColor('#888888')
      }
      .width('100%')
      .padding({ left: 16, top: 24, bottom: 8 })

      // ç‰¹æ€§åˆ—è¡¨
      Column() {
        this.FeatureItem('ğŸ¯', 'é—®é¢˜æ‹†è§£', 'å¤šè§’è‰²å¸®ä½ åˆ†æé—®é¢˜æœ¬è´¨', false)
        this.FeatureItem('ğŸ’¬', 'æƒ…ç»ªæ”¯æŒ', 'ä¸åªç»™æ–¹æ¡ˆï¼Œä¹Ÿç»™ä½ æƒ…ç»ªä»·å€¼', false)
        this.FeatureItem('âœ…', 'è¡ŒåŠ¨æ¸…å•', 'ç»™å‡ºå¯æ‰§è¡Œçš„å…·ä½“å»ºè®®', true)
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .borderRadius(8)
      .margin({ left: 12, right: 12 })
    }
    .width('100%')
  }

  @Builder
  FeatureItem(icon: string, title: string, desc: string, isLast: boolean) {
    Column() {
      Row() {
        Text(icon)
          .fontSize(24)
          .margin({ right: 12 })

        Column({ space: 2 }) {
          Text(title)
            .fontSize(15)
            .fontColor('#000000')

          Text(desc)
            .fontSize(13)
            .fontColor('#888888')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })

      if (!isLast) {
        Divider()
          .color('#EBEBEB')
          .margin({ left: 52 })
      }
    }
    .width('100%')
  }

  @Builder
  BottomTabBar() {
    Row() {
      // æ¶ˆæ¯ Tab
      Column({ space: 4 }) {
        Text(this.currentTab === 0 ? 'ğŸ’¬' : 'ğŸ’¬')
          .fontSize(24)
          .fontColor(this.currentTab === 0 ? '#07C160' : '#888888')

        Text('æ¶ˆæ¯')
          .fontSize(10)
          .fontColor(this.currentTab === 0 ? '#07C160' : '#888888')
      }
      .layoutWeight(1)
      .padding({ top: 6, bottom: 6 })
      .onClick(() => {
        this.currentTab = 0;
      })

      // é€šè®¯å½• Tab
      Column({ space: 4 }) {
        Text(this.currentTab === 1 ? 'ğŸ“–' : 'ğŸ“–')
          .fontSize(24)
          .fontColor(this.currentTab === 1 ? '#07C160' : '#888888')

        Text('é€šè®¯å½•')
          .fontSize(10)
          .fontColor(this.currentTab === 1 ? '#07C160' : '#888888')
      }
      .layoutWeight(1)
      .padding({ top: 6, bottom: 6 })
      .onClick(() => {
        this.currentTab = 1;
      })
    }
    .width('100%')
    .height(56)
    .backgroundColor('#F7F7F7')
    .border({ width: { top: 0.5 }, color: '#D9D9D9' })
  }
}

// èŠå¤©å†å²é¡¹æ•°æ®æ¨¡å‹
interface ChatHistoryItem {
  modeId: string;
  name: string;
  icon: string;
  lastMessage: string;
  timeText: string;
  timestamp: number;
}
