// ç½‘ç»œæµ‹è¯•é¡µé¢
import { http } from '@kit.NetworkKit';
import { ApiConfig } from '../config/ApiConfig';

@Entry
@Component
struct NetworkTestPage {
  @State testResult: string = 'ç‚¹å‡»æŒ‰é’®æµ‹è¯•ç½‘ç»œè¿æ¥';
  @State isLoading: boolean = false;

  build() {
    Column() {
      Text('ç½‘ç»œè¿æ¥æµ‹è¯•')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 40, bottom: 20 })

      Text(`ç›®æ ‡åœ°å€: ${ApiConfig.getBaseUrl()}`)
        .fontSize(14)
        .fontColor('#666666')
        .margin({ bottom: 20 })

      Button('æµ‹è¯•ç®€å•è¯·æ±‚')
        .width('80%')
        .margin({ bottom: 10 })
        .enabled(!this.isLoading)
        .onClick(() => {
          this.testSimpleRequest();
        })

      Button('æµ‹è¯•æµå¼è¯·æ±‚')
        .width('80%')
        .margin({ bottom: 10 })
        .enabled(!this.isLoading)
        .onClick(() => {
          this.testStreamRequest();
        })

      Button('æµ‹è¯•è¿æ¥æ€§')
        .width('80%')
        .margin({ bottom: 10 })
        .enabled(!this.isLoading)
        .onClick(() => {
          this.testConnectivity();
        })

      Button('æµ‹è¯•å¥åº·æ£€æŸ¥ï¼ˆæœ€ç®€å•ï¼‰')
        .width('80%')
        .margin({ bottom: 20 })
        .backgroundColor('#4CAF50')
        .enabled(!this.isLoading)
        .onClick(() => {
          this.testHealth();
        })

      Scroll() {
        Text(this.testResult)
          .fontSize(12)
          .fontColor('#333333')
          .width('90%')
          .padding(10)
          .backgroundColor('#f5f5f5')
          .borderRadius(8)
      }
      .layoutWeight(1)
      .width('100%')
      .padding(20)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }

  private async testSimpleRequest() {
    this.isLoading = true;
    this.testResult = 'æ­£åœ¨æµ‹è¯•ç®€å•è¯·æ±‚...\n';

    try {
      const httpRequest = http.createHttp();
      const baseUrl = ApiConfig.getBaseUrl();
      
      this.testResult += `è¯·æ±‚åœ°å€: ${baseUrl}/api/chat/stream\n`;
      
      interface RequestBody {
        message: string;
        history: Array<Record<string, string>>;
        mode: string;
      }
      
      const requestBody: RequestBody = {
        message: 'æµ‹è¯•',
        history: [],
        mode: 'emperor'
      };

      this.testResult += `è¯·æ±‚ä½“: ${JSON.stringify(requestBody)}\n`;
      this.testResult += 'å‘é€è¯·æ±‚ä¸­...\n';

      interface RequestOptions {
        method: http.RequestMethod;
        header: Record<string, string>;
        extraData: string;
        expectDataType: http.HttpDataType;
        connectTimeout: number;
        readTimeout: number;
      }
      
      const options: RequestOptions = {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json'
        },
        extraData: JSON.stringify(requestBody),
        expectDataType: http.HttpDataType.STRING,
        connectTimeout: 10000,
        readTimeout: 10000
      };

      const response = await httpRequest.request(
        `${baseUrl}/api/chat/stream`,
        options
      );

      this.testResult += `å“åº”çŠ¶æ€ç : ${response.responseCode}\n`;
      this.testResult += `å“åº”å¤´: ${JSON.stringify(response.header)}\n`;
      
      if (response.result) {
        const resultStr = typeof response.result === 'string' 
          ? response.result 
          : JSON.stringify(response.result);
        this.testResult += `å“åº”å†…å®¹ï¼ˆå‰500å­—ç¬¦ï¼‰: ${resultStr.substring(0, 500)}\n`;
      }

      this.testResult += '\nâœ… è¯·æ±‚æˆåŠŸï¼';
      httpRequest.destroy();
      
    } catch (error) {
      this.testResult += `\nâŒ é”™è¯¯: ${JSON.stringify(error)}\n`;
      this.testResult += `é”™è¯¯è¯¦æƒ…: ${error}\n`;
    }

    this.isLoading = false;
  }

  private async testStreamRequest() {
    this.isLoading = true;
    this.testResult = 'æ­£åœ¨æµ‹è¯•æµå¼è¯·æ±‚...\n';

    try {
      const httpRequest = http.createHttp();
      const baseUrl = ApiConfig.getBaseUrl();
      
      this.testResult += `è¯·æ±‚åœ°å€: ${baseUrl}/api/chat/stream\n`;
      
      interface RequestBody {
        message: string;
        history: Array<Record<string, string>>;
        mode: string;
      }
      
      const requestBody: RequestBody = {
        message: 'æµ‹è¯•',
        history: [],
        mode: 'emperor'
      };

      let receivedData = '';
      let chunkCount = 0;

      httpRequest.on('headersReceive', (header) => {
        this.testResult += `\næ”¶åˆ°å“åº”å¤´: ${JSON.stringify(header)}\n`;
      });

      httpRequest.on('dataReceive', (data: ArrayBuffer) => {
        chunkCount++;
        const text = this.arrayBufferToString(data);
        receivedData += text;
        this.testResult += `\næ•°æ®å— ${chunkCount}: ${text.substring(0, 100)}...\n`;
      });

      httpRequest.on('dataEnd', () => {
        this.testResult += `\næ•°æ®ä¼ è¾“å®Œæˆï¼Œå…±æ”¶åˆ° ${chunkCount} ä¸ªæ•°æ®å—\n`;
        this.testResult += `\nå®Œæ•´æ•°æ®ï¼ˆå‰1000å­—ç¬¦ï¼‰:\n${receivedData.substring(0, 1000)}\n`;
        this.testResult += '\nâœ… æµå¼è¯·æ±‚æˆåŠŸï¼';
        httpRequest.destroy();
        this.isLoading = false;
      });

      this.testResult += 'å‘é€æµå¼è¯·æ±‚...\n';

      interface StreamRequestOptions {
        method: http.RequestMethod;
        header: Record<string, string>;
        extraData: string;
        expectDataType: http.HttpDataType;
        connectTimeout: number;
        readTimeout: number;
      }
      
      const streamOptions: StreamRequestOptions = {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json',
          'Accept': 'text/event-stream'
        },
        extraData: JSON.stringify(requestBody),
        expectDataType: http.HttpDataType.STRING,
        connectTimeout: 10000,
        readTimeout: 30000
      };

      httpRequest.request(
        `${baseUrl}/api/chat/stream`,
        streamOptions,
        (err, data) => {
          if (err) {
            this.testResult += `\nâŒ è¯·æ±‚é”™è¯¯: ${JSON.stringify(err)}\n`;
            this.isLoading = false;
            httpRequest.destroy();
            return;
          }
          
          this.testResult += `\nå“åº”çŠ¶æ€ç : ${data.responseCode}\n`;
          
          if (data.responseCode !== 200) {
            this.testResult += `\nâŒ æœåŠ¡å™¨é”™è¯¯: ${data.responseCode}\n`;
            this.testResult += `å“åº”å†…å®¹: ${data.result}\n`;
            this.isLoading = false;
            httpRequest.destroy();
          }
        }
      );
      
    } catch (error) {
      this.testResult += `\nâŒ é”™è¯¯: ${JSON.stringify(error)}\n`;
      this.isLoading = false;
    }
  }

  private async testHealth() {
    this.isLoading = true;
    this.testResult = '=== å¥åº·æ£€æŸ¥æµ‹è¯• ===\n';
    
    const baseUrl = ApiConfig.getBaseUrl();
    this.testResult += `ç›®æ ‡: ${baseUrl}/health\n\n`;

    try {
      console.info('[NetworkTest] å¼€å§‹å¥åº·æ£€æŸ¥');
      console.info('[NetworkTest] URL:', `${baseUrl}/health`);
      
      const httpRequest = http.createHttp();
      
      console.info('[NetworkTest] å‘é€ GET è¯·æ±‚...');
      const response = await httpRequest.request(`${baseUrl}/health`, {
        method: http.RequestMethod.GET,
        connectTimeout: 5000,
        readTimeout: 5000
      });
      
      console.info('[NetworkTest] æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :', response.responseCode);
      console.info('[NetworkTest] å“åº”å†…å®¹:', response.result);
      
      this.testResult += `âœ… è¿æ¥æˆåŠŸï¼\n`;
      this.testResult += `çŠ¶æ€ç : ${response.responseCode}\n`;
      this.testResult += `å“åº”: ${response.result}\n`;
      
      httpRequest.destroy();
    } catch (error) {
      console.error('[NetworkTest] å¥åº·æ£€æŸ¥å¤±è´¥:', error);
      console.error('[NetworkTest] é”™è¯¯ç :', error.code);
      console.error('[NetworkTest] é”™è¯¯ä¿¡æ¯:', error.message);
      
      this.testResult += `âŒ è¿æ¥å¤±è´¥\n`;
      this.testResult += `é”™è¯¯ç : ${error.code}\n`;
      this.testResult += `é”™è¯¯: ${error.message}\n\n`;
      
      // æ ¹æ®é”™è¯¯ç ç»™å‡ºå»ºè®®
      if (error.code === 2300003) {
        this.testResult += `ğŸ’¡ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨\n`;
        this.testResult += `è¯·æ£€æŸ¥:\n`;
        this.testResult += `1. åç«¯æ˜¯å¦å¯åŠ¨ (npm start)\n`;
        this.testResult += `2. æ¨¡æ‹Ÿå™¨ç”¨ 10.0.2.2ï¼ŒçœŸæœºç”¨ç”µè„‘IP\n`;
        this.testResult += `3. é˜²ç«å¢™æ˜¯å¦å…è®¸3000ç«¯å£\n`;
      }
    }

    this.isLoading = false;
  }

  private async testConnectivity() {
    this.isLoading = true;
    this.testResult = 'æ­£åœ¨æµ‹è¯•ç½‘ç»œè¿æ¥æ€§...\n';

    const baseUrl = ApiConfig.getBaseUrl();
    this.testResult += `ç›®æ ‡åœ°å€: ${baseUrl}\n\n`;

    // æµ‹è¯•1: åŸºæœ¬è¿æ¥
    this.testResult += 'ã€æµ‹è¯•1ã€‘åŸºæœ¬HTTPè¿æ¥\n';
    try {
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(baseUrl, {
        method: http.RequestMethod.GET,
        connectTimeout: 5000,
        readTimeout: 5000
      });
      this.testResult += `âœ… è¿æ¥æˆåŠŸï¼ŒçŠ¶æ€ç : ${response.responseCode}\n\n`;
      httpRequest.destroy();
    } catch (error) {
      this.testResult += `âŒ è¿æ¥å¤±è´¥\n`;
      this.testResult += `é”™è¯¯ç : ${error.code}\n`;
      this.testResult += `é”™è¯¯ä¿¡æ¯: ${error.message}\n`;
      this.testResult += `\nğŸ’¡ å»ºè®®:\n`;
      this.testResult += `- å¦‚æœæ˜¯æ¨¡æ‹Ÿå™¨ï¼Œç¡®è®¤ä½¿ç”¨ 10.0.2.2\n`;
      this.testResult += `- å¦‚æœæ˜¯çœŸæœºï¼Œç¡®è®¤ä½¿ç”¨ç”µè„‘IPåœ°å€\n`;
      this.testResult += `- ç¡®è®¤åç«¯æœåŠ¡å·²å¯åŠ¨ (npm start)\n`;
      this.testResult += `- ç¡®è®¤é˜²ç«å¢™å…è®¸3000ç«¯å£\n\n`;
    }

    // æµ‹è¯•2: APIç«¯ç‚¹
    this.testResult += 'ã€æµ‹è¯•2ã€‘APIç«¯ç‚¹å¯è¾¾æ€§\n';
    try {
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(`${baseUrl}/api/chat/stream`, {
        method: http.RequestMethod.OPTIONS,
        connectTimeout: 5000,
        readTimeout: 5000
      });
      this.testResult += `âœ… APIç«¯ç‚¹å¯è¾¾ï¼ŒçŠ¶æ€ç : ${response.responseCode}\n\n`;
      httpRequest.destroy();
    } catch (error) {
      this.testResult += `âŒ APIç«¯ç‚¹ä¸å¯è¾¾\n`;
      this.testResult += `é”™è¯¯: ${error.message}\n\n`;
    }

    // æµ‹è¯•3: ç½‘ç»œæƒé™
    this.testResult += 'ã€æµ‹è¯•3ã€‘ç½‘ç»œæƒé™æ£€æŸ¥\n';
    this.testResult += `âœ… INTERNETæƒé™å·²é…ç½®\n`;
    this.testResult += `âœ… GET_NETWORK_INFOæƒé™å·²é…ç½®\n\n`;

    this.testResult += 'ã€é…ç½®ä¿¡æ¯ã€‘\n';
    this.testResult += `å½“å‰ç¯å¢ƒ: ${ApiConfig.CURRENT_ENV}\n`;
    this.testResult += `Base URL: ${baseUrl}\n`;
    this.testResult += `è¿æ¥è¶…æ—¶: ${ApiConfig.TIMEOUT.CONNECT}ms\n`;
    this.testResult += `è¯»å–è¶…æ—¶: ${ApiConfig.TIMEOUT.READ}ms\n`;

    this.isLoading = false;
  }

  private arrayBufferToString(buffer: ArrayBuffer): string {
    const uint8Array = new Uint8Array(buffer);
    let result = '';
    for (let i = 0; i < uint8Array.length; i++) {
      result += String.fromCharCode(uint8Array[i]);
    }
    return result;
  }
}
